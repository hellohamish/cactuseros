(function(){var b,a={}.hasOwnProperty,c=[].slice;if(((b=this["google"])!=null?b.maps:void 0)==null){return}this["OverlappingMarkerSpiderfier"]=(function(){var g,j,d,k,e,i,f;i=h.prototype;i.VERSION="0.3";j=google.maps;g=j.event;e=j.MapTypeId;f=Math.PI*2;i.keepSpiderfied=false;i.markersWontHide=false;i.markersWontMove=false;i.nearbyDistance=20;i.circleSpiralSwitchover=9;i.circleFootSeparation=23*3;i.circleStartAngle=f/12;i.spiralFootSeparation=26;i.spiralLengthStart=11;i.spiralLengthFactor=4;i.spiderfiedZIndex=1000;i.usualLegZIndex=10;i.highlightedLegZIndex=20;i.legWeight=1.5;i.legColors={usual:{},highlighted:{}};k=i.legColors["usual"];d=i.legColors["highlighted"];k[e.HYBRID]=k[e.SATELLITE]="#fff";d[e.HYBRID]=d[e.SATELLITE]="#f00";k[e.TERRAIN]=k[e.ROADMAP]="#444";d[e.TERRAIN]=d[e.ROADMAP]="#f00";function h(m,l){var r,n,t,p,s,o,q=this;this.map=m;if(l==null){l={}}for(n in l){if(!a.call(l,n)){continue}t=l[n];this[n]=t}this.projHelper=new this.constructor.ProjHelper(this.map);this.initMarkerArrays();this.listeners={};o=["click","zoom_changed","maptypeid_changed"];for(p=0,s=o.length;p<s;p++){r=o[p];g.addListener(this.map,r,function(){return q.unspiderfy()})}}i.initMarkerArrays=function(){this.markers=[];return this.markerListenerRefs=[]};i.addMarker=function(l){var m,n=this;if(l._oms!=null){return this}l._oms=true;m=[g.addListener(l,"click",function(){return n.spiderListener(l)})];if(!this["markersWontHide"]){m.push(g.addListener(l,"visible_changed",function(){return n.markerChangeListener(l,false)}))}if(!this["markersWontMove"]){m.push(g.addListener(l,"position_changed",function(){return n.markerChangeListener(l,true)}))}this.markerListenerRefs.push(m);this.markers.push(l);return this};i.markerChangeListener=function(m,l){if((m._omsData!=null)&&(l||!m.getVisible())&&!((this.spiderfying!=null)||(this.unspiderfying!=null))){return this.unspiderfy(l?m:null)}};i.getMarkers=function(){return this.markers.slice(0)};i.removeMarker=function(m){var n,q,o,p,l;if(m._omsData!=null){this["unspiderfy"]()}n=this.arrIndexOf(this.markers,m);if(n<0){return this}o=this.markerListenerRefs.splice(n,1)[0];for(p=0,l=o.length;p<l;p++){q=o[p];g.removeListener(q)}delete m._oms;this.markers.splice(n,1);return this};i.clearMarkers=function(){var r,l,n,s,q,p,t,m,o;this["unspiderfy"]();o=this.markers;for(r=q=0,t=o.length;q<t;r=++q){s=o[r];n=this.markerListenerRefs[r];for(p=0,m=n.length;p<m;p++){l=n[p];g.removeListener(l)}delete s._oms}this.initMarkerArrays();return this};i.addListener=function(o,n){var m,l;((l=(m=this.listeners)[o])!=null?l:m[o]=[]).push(n);return this};i.removeListener=function(n,m){var l;l=this.arrIndexOf(this.listeners[n],m);if(!(l<0)){this.listeners[n].splice(l,1)}return this};i.clearListeners=function(l){this.listeners[l]=[];return this};i.trigger=function(){var o,q,p,r,n,l,s,m;q=arguments[0],o=2<=arguments.length?c.call(arguments,1):[];s=(l=this.listeners[q])!=null?l:[];m=[];for(r=0,n=s.length;r<n;r++){p=s[r];m.push(p.apply(null,o))}return m};i.generatePtsCircle=function(q,l){var m,t,r,p,s,o,n;r=this["circleFootSeparation"]*(2+q);s=r/f;t=f/q;n=[];for(p=o=0;0<=q?o<q:o>q;p=0<=q?++o:--o){m=this["circleStartAngle"]+p*t;n.push(new j.Point(l.x+s*Math.cos(m),l.y+s*Math.sin(m)))}return n};i.generatePtsSpiral=function(n,s){var r,m,p,q,o,l;p=this["spiralLengthStart"];r=0;l=[];for(m=o=0;0<=n?o<n:o>n;m=0<=n?++o:--o){r+=this["spiralFootSeparation"]/p+m*0.0005;q=new j.Point(s.x+p*Math.cos(r),s.y+p*Math.sin(r));p+=f*this["spiralLengthFactor"]/r;l.push(q)}return l};i.spiderListener=function(s){var o,w,r,x,t,n,u,l,q,v,p;x=s._omsData!=null;if(!(x&&this["keepSpiderfied"])){this["unspiderfy"]()}if(x||this.map.getStreetView().getVisible()){return this.trigger("click",s)}else{n=[];u=[];t=this["nearbyDistance"];l=t*t;r=this.llToPt(s.position);p=this.markers;for(q=0,v=p.length;q<v;q++){o=p[q];if(!((o.map!=null)&&o.getVisible())){continue}w=this.llToPt(o.position);if(this.ptDistanceSq(w,r)<l){n.push({marker:o,markerPt:w})}else{u.push(o)}}if(n.length===1){return this.trigger("click",s)}else{return this.spiderfy(n,u)}}};i.markersNearMarker=function(u,y){var o,x,t,s,v,l,r,w,q,p,n;if(y==null){y=false}if(this.projHelper.getProjection()==null){throw"Must wait for 'idle' event on map before calling markersNearMarker"}v=this["nearbyDistance"];l=v*v;t=this.llToPt(u.position);s=[];q=this.markers;for(r=0,w=q.length;r<w;r++){o=q[r];if(o===u||!(o.map!=null)||!o.getVisible()){continue}x=this.llToPt((p=(n=o._omsData)!=null?n.usualPosition:void 0)!=null?p:o.position);if(this.ptDistanceSq(x,t)<l){s.push(o);if(y){break}}}return s};i.markersNearAnyOtherMarker=function(){var B,z,x,y,n,C,l,v,w,A,D,s,p,o,E,G,F,u,t,r,q;if(this.projHelper.getProjection()==null){throw"Must wait for 'idle' event on map before calling markersNearAnyOtherMarker"}A=this["nearbyDistance"];D=A*A;w=(function(){var J,I,m,L,K,H;m=this.markers;H=[];for(J=0,I=m.length;J<I;J++){y=m[J];H.push({pt:this.llToPt((L=(K=y._omsData)!=null?K.usualPosition:void 0)!=null?L:y.position),willSpiderfy:false})}return H}).call(this);u=this.markers;for(z=s=0,E=u.length;s<E;z=++s){n=u[z];if(!((n.map!=null)&&n.getVisible())){continue}C=w[z];if(C.willSpiderfy){continue}t=this.markers;for(x=p=0,G=t.length;p<G;x=++p){l=t[x];if(x===z){continue}if(!((l.map!=null)&&l.getVisible())){continue}v=w[x];if(x<z&&!v.willSpiderfy){continue}if(this.ptDistanceSq(C.pt,v.pt)<D){C.willSpiderfy=v.willSpiderfy=true;break}}}r=this.markers;q=[];for(B=o=0,F=r.length;o<F;B=++o){y=r[B];if(w[B].willSpiderfy){q.push(y)}}return q};i.makeHighlightListenerFuncs=function(l){var m=this;return{highlight:function(){return l._omsData.leg.setOptions({strokeColor:m.legColors["highlighted"][m.map.mapTypeId],zIndex:m.highlightedLegZIndex})},unhighlight:function(){return l._omsData.leg.setOptions({strokeColor:m.legColors["usual"][m.map.mapTypeId],zIndex:m.usualLegZIndex})}}};i.spiderfy=function(m,q){var v,u,l,p,r,w,o,t,n,s,x;this.spiderfying=true;s=m.length;v=this.ptAverage((function(){var A,z,y;y=[];for(A=0,z=m.length;A<z;A++){t=m[A];y.push(t.markerPt)}return y})());p=s>=this["circleSpiralSwitchover"]?this.generatePtsSpiral(s,v).reverse():this.generatePtsCircle(s,v);x=(function(){var A,z,y,B=this;y=[];for(A=0,z=p.length;A<z;A++){l=p[A];u=this.ptToLl(l);n=this.minExtract(m,function(C){return B.ptDistanceSq(C.markerPt,l)});o=n.marker;w=new j.Polyline({map:this.map,path:[o.position,u],strokeColor:this["legColors"]["usual"][this.map.mapTypeId],strokeWeight:this["legWeight"],zIndex:this["usualLegZIndex"]});o._omsData={usualPosition:o.position,leg:w};if(this["legColors"]["highlighted"][this.map.mapTypeId]!==this["legColors"]["usual"][this.map.mapTypeId]){r=this.makeHighlightListenerFuncs(o);o._omsData.hightlightListeners={highlight:g.addListener(o,"mouseover",r.highlight),unhighlight:g.addListener(o,"mouseout",r.unhighlight)}}o.setPosition(u);o.setZIndex(Math.round(this["spiderfiedZIndex"]+l.y));y.push(o)}return y}).call(this);delete this.spiderfying;this.spiderfied=true;return this.trigger("spiderfy",x,q)};i.unspiderfy=function(o){var q,n,s,p,r,m,l;if(o==null){o=null}if(this.spiderfied==null){return this}this.unspiderfying=true;p=[];s=[];l=this.markers;for(r=0,m=l.length;r<m;r++){n=l[r];if(n._omsData!=null){n._omsData.leg.setMap(null);if(n!==o){n.setPosition(n._omsData.usualPosition)}n.setZIndex(null);q=n._omsData.hightlightListeners;if(q!=null){g.removeListener(q.highlight);g.removeListener(q.unhighlight)}delete n._omsData;p.push(n)}else{s.push(n)}}delete this.unspiderfying;delete this.spiderfied;this.trigger("unspiderfy",p,s);return this};i.ptDistanceSq=function(o,n){var m,l;m=o.x-n.x;l=o.y-n.y;return m*m+l*l};i.ptAverage=function(r){var p,o,q,n,m,l;q=n=0;for(m=0,l=r.length;m<l;m++){o=r[m];q+=o.x;n+=o.y}p=r.length;return new j.Point(q/p,n/p)};i.llToPt=function(l){return this.projHelper.getProjection().fromLatLngToDivPixel(l)};i.ptToLl=function(l){return this.projHelper.getProjection().fromDivPixelToLatLng(l)};i.minExtract=function(s,n){var p,l,q,t,m,o,r;for(q=o=0,r=s.length;o<r;q=++o){t=s[q];m=n(t);if(!(typeof p!=="undefined"&&p!==null)||m<l){l=m;p=q}}return s.splice(p,1)[0]};i.arrIndexOf=function(l,q){var n,r,p,m;if(l.indexOf!=null){return l.indexOf(q)}for(n=p=0,m=l.length;p<m;n=++p){r=l[n];if(r===q){return n}}return -1};h.ProjHelper=function(l){return this.setMap(l)};h.ProjHelper.prototype=new j.OverlayView();h.ProjHelper.prototype.draw=function(){};return h})()}).call(this);